// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight            motor         10              
// intakeLeft           motor         4               
// indexer              motor         6               
// shooter              motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight            motor         10              
// intakeLeft           motor         4               
// indexer              motor         6               
// shooter              motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight            motor         10              
// intakeLeft           motor         4               
// indexer              motor         6               
// shooter              motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight            motor         10              
// intakeLeft           motor         4               
// indexer              motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight            motor         10              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft             motor         2               
// topRight             motor         9               
// backRight          motor         10              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft           motor         2               
// topRight             motor         9               
// backRight          motor         10              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft           motor         2               
// topRight             motor         21              
// backRight          motor         10              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         21              
// backRight          motor         10              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         21              
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         6               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         21              
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         7               
// shooter           motor         3               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         21              
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// intakeRight          motor         5               
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         4               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         5               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         5               
// intakeRight          motor         4               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         5               
// intakeRight          motor         6               
// indexer         motor         7               
// shooter           motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         12              
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         5               
// intakeRight          motor         6               
// indexer         motor         7               
// flywheel             motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         11              
// intakeLeft           motor         5               
// intakeRight          motor         6               
// indexer         motor         7               
// flywheel             motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         4               
// intakeLeft           motor         5               
// intakeRight          motor         6               
// indexer         motor         7               
// flywheel             motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// topLeft              motor         1               
// backLeft           motor         2               
// topRight             motor         3               
// backRight          motor         4               
// intakeLeft           motor         5               
// intakeRight          motor         6               
// indexer         motor         7               
// flywheel             motor         8               
// Controller1          controller                    
// ---- END VEXCODE CONFIGURED DEVICES ----
/*----------------------------------------------------------------------------*/
/*                                                                            */
/*    Module:       main.cpp                                                  */
/*    Author:       Adam Xu, Shafin Haque                                     */
/*    Created:      Thu Sep 26 2019                                           */
/*    Description:  53343A Comp code                                          */
/*                                                                            */
/*----------------------------------------------------------------------------*/
 
#include "vex.h"
#include <cmath>
#include <iostream>
#include <iomanip>
#include <map>
#include <string>
#include <sstream>
 
using namespace vex;
 
competition Competition;
 
bool DEBUG_MODE = true;
float PI = 3.14159265;
float TURN_MULT = 0.6;
float INCH_MULT = 28;
int SELECTED_AUTON = 5;
bool AUTON_LOCKED = false;

double averageEncoderVal() {
  return (topLeft.position(deg) + topRight.position(deg) +
    backLeft.position(deg) + backRight.position(deg))/4;
}

void accelVertical(double v, double inches) {
  topLeft.resetPosition(); topRight.resetPosition(); 
  backLeft.resetPosition(); backRight.resetPosition();

  double error; double desired = inches * INCH_MULT;
  double justify = v / (desired*desired);

  while (true) {
    error = desired - averageEncoderVal();
    if (error >= -5 && error <= 5) {
      topLeft.stop(brake);
      topRight.stop(brake);
      backLeft.stop(brake);
      backRight.stop(brake);
      break;
    }

    double pwr = justify * averageEncoderVal() * averageEncoderVal() + 35;

    topLeft.spin(fwd, pwr, pct); topRight.spin(fwd, pwr, pct); backLeft.spin(fwd, pwr, pct); backRight.spin(fwd, pwr, pct); 
  }
}

void accelRight(double v, double inches) {
  topLeft.resetPosition(); topRight.resetPosition(); 
  backLeft.resetPosition(); backRight.resetPosition();

  double error; double desired = inches * INCH_MULT;
  double justify = v / (desired*desired);

  while (true) {
    error = desired - topLeft.position(deg);
    if (error >= -5 && error <= 5) {
      topLeft.stop(brake);
      topRight.stop(brake);
      backLeft.stop(brake);
      backRight.stop(brake);

      break;
    }
    double pwr = justify * topLeft.position(deg) * topLeft.position(deg) + 35;
    topLeft.spin(fwd, pwr, pct); topRight.spin(fwd, -1 * pwr, pct);
    backLeft.spin(fwd, -1 * pwr, pct); backRight.spin(fwd, pwr, pct); 
  }
}

void accelLeft(double v, double inches) {
  topLeft.resetPosition(); topRight.resetPosition(); 
  backLeft.resetPosition(); backRight.resetPosition();

  double error; double desired = inches * INCH_MULT;
  double justify = v / (desired*desired);

  while (true) {
    error = desired - topRight.position(deg);
    if (error >= -5 && error <= 5) {
      topLeft.stop(brake);
      topRight.stop(brake);
      backLeft.stop(brake);
      backRight.stop(brake);

      break;
    }
    double pwr = justify * topRight.position(deg) * topRight.position(deg) + 35;
    topLeft.spin(fwd, -1*pwr, pct); topRight.spin(fwd, pwr, pct);
    backLeft.spin(fwd, pwr, pct); backRight.spin(fwd, -1*pwr, pct); 
  }
}
 
void vertical(double v, double inches) {
  topLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  topRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, true);
}
 
void turn90(double v, double dir) {
  topLeft.rotateFor(dir * 450, deg, v, velocityUnits::pct, false);
  topRight.rotateFor(dir * -450, deg, v, velocityUnits::pct, false);
  backLeft.rotateFor(dir * 450, deg, v, velocityUnits::pct, false);
  backRight.rotateFor(dir * -450, deg, v, velocityUnits::pct, true);
}
 
void left_strafe(double v, double inches) {
  topLeft.rotateFor(-1 * inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  topRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backRight.rotateFor(-1 * inches * INCH_MULT, deg, v, velocityUnits::pct, true);
}
 
void right_strafe(double v, double inches) {
  topLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  topRight.rotateFor(-1 * inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backLeft.rotateFor(-1 * inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, true);
}
 
void flipout(){
  intakeLeft.spin(fwd, 50, pct);
  intakeRight.spin(fwd, 50, pct);
  wait(0.75, sec);
  intakeLeft.stop();
  intakeRight.stop();
}

void deploy(){
  indexer.spin(fwd, 25, percentUnits:: pct);
  wait(0.75, sec);
  indexer.stop();
}

void avertical (double v, double inches) {
  topLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backLeft.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  topRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
  backRight.rotateFor(inches * INCH_MULT, deg, v, velocityUnits::pct, false);
}

void arms (double v) {
  intakeLeft.spin(reverse, v, pct); intakeRight.spin(reverse, v, pct);
}

void haltArms () { intakeLeft.stop(); intakeRight.stop(); }

void intake(double v) {
  indexer.spin(directionType::rev, v, percentUnits::pct);
  intakeLeft.spin(reverse, v, pct);
  intakeRight.spin(reverse, v, pct);
}

void haltIntake() {
  indexer.stop();
  intakeRight.stop();
  intakeLeft.stop();
}

void shoot (double v) { shooter.spin(fwd, v, pct); }

void haltShoot () { shooter.stop(); }

void cycle (double v) {
  indexer.spin(reverse, v, pct);
  intakeLeft.spin(reverse, v, pct);
  intakeRight.spin(reverse, v, pct);
  shooter.spin(fwd, v, pct);
}

void haltCycle () {
  indexer.stop(); 
  intakeLeft.stop(); intakeRight.stop(); 
  shooter.stop();
}
  
void pre_auton(void) {
  // Initializing Robot Configuration. DO NOT REMOVE!
  vexcodeInit();
 
  while (AUTON_LOCKED == false) {
    if (Controller1.ButtonUp.pressing() && SELECTED_AUTON < 8) {
      SELECTED_AUTON++;
    } else if (Controller1.ButtonDown.pressing() && SELECTED_AUTON > 1) {
      SELECTED_AUTON--;
    } 

    std::stringstream preAutText;
    preAutText << "(" << Brain.Battery.capacity() << "\%)" << " [AUT" << SELECTED_AUTON << "]"; 
 
    Controller1.Screen.clearScreen();
    Controller1.Screen.setCursor(1, 1);
    Controller1.Screen.print(preAutText.str().c_str());

    if (Controller1.ButtonA.pressing()) {
      AUTON_LOCKED = true;
      Controller1.Screen.clearScreen();
      Controller1.Screen.setCursor(1, 1);
      Controller1.Screen.print("LOCKED");
      Controller1.rumble(".");
    } 
  }
}
 
void autonomous(void) {
  if (SELECTED_AUTON == 1) {
    // Right side, 1 goal
    deploy();

    vertical(100, 18);
    turn90(100, 1.5);

    arms(100);
    vertical(20, 12);
    haltArms(); 

    cycle(100);
    wait(2, sec);
    haltCycle();
  } else if (SELECTED_AUTON == 2) {
  
  } else if (SELECTED_AUTON == 3) {

  } else if (SELECTED_AUTON == 4) {
   
  } else if (SELECTED_AUTON == 5) {

  } else if (SELECTED_AUTON == 6) {

  } else if (SELECTED_AUTON == 7) { 
    /*
    * Skills Auton
    * Four-goal, encoder, some wait-time utilized
    */
    deploy();
    backLeft.spin(fwd, 100, pct);
    backRight.spin(reverse, 100, pct); 
    topRight.spin(fwd, 60, pct);
    topLeft.spin(fwd, 35, pct);
    wait(330, msec);
    backLeft.stop(brake);
    backRight.stop(brake);
    topRight.stop(brake);
    topLeft.stop(brake);
    wait(0.4, sec);

    // shoot first goal
    shooter.spin(fwd, 75, pct);
    wait(1, sec);
    indexer.spin(reverse, 100, pct);
    wait(0.5, sec);
    indexer.stop();
    wait(0.3, sec);
    shooter.stop();

    // position for intaking second ball
    backLeft.spin(fwd, 100, pct);
    backRight.spin(reverse, 100, pct); 
    topRight.spin(fwd, 60, pct);
    topLeft.spin(fwd, 35, pct);
    wait(500, msec);
    backLeft.stop(brake);
    backRight.stop(brake);
    topRight.stop(brake);
    topLeft.stop(brake);
    wait(0.4, sec);

    vertical(50, -4);
    wait(0.2, sec);
    turn90(100, 1.25);
    vertical(75, -7);
    wait(0.5, sec);

    flipout();
    wait(1, sec);

    // intake second ball
    indexer.spin(reverse, 100, pct);
    intakeRight.spin(reverse, 100, pct);
    intakeLeft.spin(reverse, 100, pct);
    accelVertical(70, 42);
    indexer.stop();
    intakeRight.stop();
    intakeLeft.stop();

    wait(0.4, sec);
    turn90(100, -1.05);
    wait(0.2, sec);

    // shoot 2nd shot
    shooter.spin(fwd, 100, pct);
    wait(1, sec);
    indexer.spin(reverse, 100, pct);
    wait(0.5, sec);
    indexer.stop();
    wait(0.3, sec);
    shooter.stop();

    // position and intake for 3rd shot
    turn90(100, 1);
    wait(0.4, sec);

    indexer.spin(reverse, 100, pct);
    intakeRight.spin(reverse, 100, pct);
    intakeLeft.spin(reverse, 100, pct);
    accelVertical(75, 35);
    wait(0.2, sec);

    turn90(100, -0.5);
    wait(0.2, sec);
    vertical(100, 5);
    wait(0.2, sec);

    indexer.stop();
    intakeRight.stop();
    intakeLeft.stop();

    // shoot third shot
    shooter.spin(fwd, 100, pct);
    wait(0.5, sec);
    indexer.spin(reverse, 100, pct);
    wait(0.6, sec);
    indexer.stop();
    wait(0.5, sec);
    shooter.stop();

    // fourth
    // vertical(100, -12);
    // turn90(100, 2);

    // indexer.spin(reverse, 100, pct);
    // intakeRight.spin(reverse, 100, pct);
    // intakeLeft.spin(reverse, 100, pct);
    // accelVertical(100, 30);
    // indexer.stop();
    // intakeRight.stop();
    // intakeLeft.stop();

    // turn90(100, -1.1);
    // flywheel.spin(fwd, 100, pct);
    // wait(0.5, sec);
    // indexer.spin(reverse, 100, pct);
    // wait(0.6, sec);
    // indexer.stop();
    // wait(0.3, sec);
    // flywheel.stop();
  } 
}
 
void usercontrol(void) {
  int intakeSpeed = 100;
  double nja_md = 1;

  topLeft.setBrake(brake);
  topRight.setBrake(brake); 
  backLeft.setBrake(brake);
  backRight.setBrake(brake);
 
  while (true) {
    topLeft.spin(fwd, nja_md*(Controller1.Axis3.position(pct) + 0.7*Controller1.Axis1.position()), pct);
    topRight.spin(fwd, nja_md*(Controller1.Axis3.position(pct) - 0.7*Controller1.Axis1.position()), pct);
    backLeft.spin(fwd, nja_md*(Controller1.Axis3.position(pct) + 0.7*Controller1.Axis1.position()), pct);
    backRight.spin(fwd, nja_md*(Controller1.Axis3.position(pct) - 0.7*Controller1.Axis1.position()), pct);
 
    if (Controller1.ButtonL1.pressing()) {
      intakeLeft.spin(reverse, intakeSpeed, pct);
      intakeRight.spin(reverse, intakeSpeed, pct);
      indexer.spin(reverse, intakeSpeed, pct);
      shooter.spin(reverse, intakeSpeed, pct);
    } else if (Controller1.ButtonR1.pressing()) {
      intakeLeft.spin(fwd, intakeSpeed, pct);
      intakeRight.spin(fwd, intakeSpeed, pct);
      indexer.spin(fwd, intakeSpeed, pct);
      shooter.spin(fwd, intakeSpeed, pct);
    } else {
      intakeLeft.stop(brake);
      intakeRight.stop(brake);
      indexer.stop(brake);
      shooter.stop(brake);
    }

    if (Controller1.ButtonB.pressing()) {
      nja_md = 0.3;
      Controller1.Screen.setCursor(3, 1);
      Controller1.Screen.print("[NINJA]");
    } else {
      nja_md = 1;
    }

    if (Controller1.ButtonX.pressing()) {
      autonomous();
    }
  }
}
 
//
// Main will set up the competition functions and callbacks.
//
int main() {
  // Set up callbacks for autonomous and driver control periods.
  Competition.autonomous(autonomous);
  Competition.drivercontrol(usercontrol);
  
  // Run the pre-autonomous function.
  pre_auton();
  
  // Prevent main from exiting with an infinite loop.
  while (true) {
    if (AUTON_LOCKED  && DEBUG_MODE) {
      std::stringstream top;
      std::stringstream bottom;
      top << "[" << round(topLeft.temperature(temperatureUnits::fahrenheit)) << 
        "] [" << round(topRight.temperature(temperatureUnits::fahrenheit)) << "]";
      bottom << "[" << round(backLeft.temperature(temperatureUnits::fahrenheit)) << 
        "] [" << round(backRight.temperature(temperatureUnits::fahrenheit)) << "]";

      Controller1.Screen.setCursor(1, 1);
      Controller1.Screen.print(top.str().c_str());
      Controller1.Screen.newLine();
      Controller1.Screen.print(bottom.str().c_str());
      Controller1.Screen.newLine();
    }

    wait(1000, msec);
    Controller1.Screen.clearScreen();
  }
}
